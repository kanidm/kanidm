name: Build Deb Package

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
  release:
    types: ["published"]
jobs:
  build-deb-package:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Update package manager
      run: sudo apt-get update

    - name: Install dependencies
      run: |
        sudo apt-get install -y \
          libpam0g-dev \
          libudev-dev \
          libssl-dev \
          libsqlite3-dev

    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable

    - name: "Run clippy (ignores errors, this is just a check)"
      run: cargo clippy --no-deps
      continue-on-error: true
      - run: find platforms/debian/ -name 'p*' -exec chmod 555 "{}" \;
      - run:
      - run: dpkg-deb --build --root-owner-group kanidm
      # - name: Release
      #   uses: softprops/action-gh-release@v1
      #   if: startsWith(github.ref, 'refs/tags/')
      #   with:
      #     files: kanidm.deb